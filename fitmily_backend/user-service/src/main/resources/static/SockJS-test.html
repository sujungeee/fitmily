<!DOCTYPE html>
<html>
<head>
  <title>간단한 SockJS 테스트</title>
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.5.0/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stomp-websocket@2.3.4-next/lib/stomp.min.js"></script>
</head>
<body>
<h1>간단한 SockJS 테스트</h1>
<input id="token" type="text" placeholder="Bearer 토큰" style="width: 500px"><br>
<button id="connect">SockJS만 연결</button>
<button id="connect-stomp">STOMP 연결</button>
<div id="log" style="height: 300px; overflow-y: scroll; border: 1px solid black; padding: 10px; margin-top: 10px;"></div>

<script>
  // 로그 함수
  function addLog(message) {
    const log = document.getElementById('log');
    const div = document.createElement('div');
    div.textContent = new Date().toLocaleTimeString() + ': ' + message;
    log.appendChild(div);
    log.scrollTop = log.scrollHeight;
  }

  // SockJS만 연결 버튼
  document.getElementById('connect').addEventListener('click', function() {
    addLog('SockJS 연결 시도...');

    try {
      // SockJS 옵션 설정
      const options = {
        transports: ['websocket', 'xhr-streaming', 'xhr-polling'],
        debug: true
      };

      // SockJS 연결만 테스트
      const socket = new SockJS('http://localhost:8080/api/ws-connect', null, options);

      socket.onopen = function() {
        addLog('SockJS 소켓 연결 성공!');
      };

      socket.onmessage = function(e) {
        addLog('메시지 수신: ' + e.data);
      };

      socket.onclose = function(e) {
        addLog('소켓 닫힘: code=' + e.code + ', reason=' + e.reason);
      };

      socket.onerror = function(e) {
        addLog('소켓 오류: ' + e);
      };
    } catch(e) {
      addLog('오류 발생: ' + e.message);
    }
  });

  // STOMP 연결 버튼
  document.getElementById('connect-stomp').addEventListener('click', function() {
    const token = document.getElementById('token').value;

    if (!token || !token.startsWith('Bearer ')) {
      addLog('유효한 Bearer 토큰을 입력하세요');
      return;
    }

    addLog('STOMP 연결 시도...');

    try {
      // SockJS 옵션 설정
      const options = {
        transports: ['websocket', 'xhr-streaming', 'xhr-polling'],
        debug: true
      };

      // SockJS 소켓 생성
      const socket = new SockJS('http://localhost:8080/api/ws-connect', null, options);

      socket.onopen = function() {
        addLog('SockJS 소켓 열림');
      };

      socket.onclose = function(e) {
        addLog('SockJS 소켓 닫힘: code=' + e.code + ', reason=' + e.reason);
      };

      // STOMP 클라이언트 생성
      const stompClient = Stomp.over(socket);

      // 디버그 로깅 활성화
      stompClient.debug = function(str) {
        addLog('STOMP: ' + str);
      };

      // 연결 헤더 설정
      const headers = {
        'Authorization': token
      };

      // STOMP 연결
      stompClient.connect(headers,
        // 성공 콜백
        function(frame) {
          addLog('STOMP 연결 성공: ' + frame);

          // 채팅방 구독
          const subscription = stompClient.subscribe('/topic/chat/family/1', function(message) {
            addLog('메시지 수신: ' + message.body);
          });

          addLog('채팅방 구독 완료: /topic/chat/family/1');

          // 테스트 메시지 전송
          setTimeout(function() {
            stompClient.send('/app/chat.sendMessage/family/1', {}, JSON.stringify({
              messageType: 'text',
              content: '테스트 메시지'
            }));
            addLog('테스트 메시지 전송됨');
          }, 2000);
        },
        // 에러 콜백
        function(error) {
          addLog('STOMP 연결 실패: ' + error);
        }
      );
    } catch(e) {
      addLog('오류 발생: ' + e.message);
    }
  });
</script>
</body>
</html>