<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fitmily ì±„íŒ…ë°© í…ŒìŠ¤íŠ¸</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Apple SD Gothic Neo', 'Noto Sans KR', sans-serif;
        }

        body {
            background-color: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .login-container {
            padding: 20px;
            border-bottom: 1px solid #eee;
        }

        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 20px;
            font-size: 24px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }

        .button {
            display: inline-block;
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            transition: background-color 0.2s;
            width: 100%;
        }

        .button:hover {
            background-color: #45a049;
        }

        .chat-container {
            display: none;
            height: 500px;
            position: relative;
        }

        .chat-header {
            padding: 15px;
            background-color: #4CAF50;
            color: white;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .family-name {
            font-size: 18px;
        }

        .chat-messages {
            padding: 15px;
            height: 400px;
            overflow-y: auto;
            background-color: #f9f9f9;
        }

        .message {
            margin-bottom: 15px;
            max-width: 80%;
            clear: both;
        }

        .message.received {
            float: left;
        }

        .message.sent {
            float: right;
        }

        .message-content {
            background-color: #e5e5ea;
            padding: 10px;
            border-radius: 15px;
            position: relative;
            word-break: break-word;
        }

        .message.sent .message-content {
            background-color: #dcf8c6;
        }

        .message-sender {
            font-size: 12px;
            color: #777;
            margin-bottom: 3px;
            display: block;
        }

        .message-time {
            font-size: 11px;
            color: #999;
            text-align: right;
            margin-top: 2px;
            display: block;
        }

        .chat-footer {
            padding: 15px;
            border-top: 1px solid #eee;
            display: flex;
            align-items: center;
        }

        .pagination {
            display: flex;
            justify-content: center;
            padding: 10px;
            background-color: #fff;
            border-top: 1px solid #eee;
        }

        .pagination-button {
            background-color: #eee;
            border: none;
            padding: 8px 15px;
            margin: 0 5px;
            border-radius: 4px;
            cursor: pointer;
        }

        .pagination-button:disabled {
            background-color: #f5f5f5;
            color: #aaa;
            cursor: not-allowed;
        }

        .pagination-info {
            display: flex;
            align-items: center;
            color: #777;
            font-size: 14px;
        }

        .status {
            padding: 10px;
            background-color: #f8d7da;
            color: #721c24;
            border-radius: 5px;
            margin-top: 10px;
            display: none;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .zodiac-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
            vertical-align: middle;
            text-align: center;
            line-height: 20px;
            font-size: 12px;
            color: white;
            font-weight: bold;
        }

        /* ì±„íŒ…ë°©ì— ìƒˆë¡œìš´ ë©”ì‹œì§€ê°€ ì—†ì„ ë•Œ */
        .no-messages {
            text-align: center;
            color: #999;
            padding: 20px;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="login-container" id="loginContainer">
        <h1>Fitmily ì±„íŒ…ë°© í…ŒìŠ¤íŠ¸</h1>

        <div class="form-group">
            <label for="token">ì¸ì¦ í† í°</label>
            <input type="text" id="token" placeholder="JWT í† í°ì„ ì…ë ¥í•˜ì„¸ìš”">
        </div>

        <div class="form-group">
            <label for="familyId">ê°€ì¡± ID</label>
            <input type="text" id="familyId" placeholder="ê°€ì¡± IDë¥¼ ì…ë ¥í•˜ì„¸ìš”">
        </div>

        <div class="form-group">
            <label for="userId">ì‚¬ìš©ì ID (UI í‘œì‹œìš©)</label>
            <input type="text" id="userId" placeholder="ì‚¬ìš©ì IDë¥¼ ì…ë ¥í•˜ì„¸ìš”">
        </div>

        <button class="button" id="enterChat">ì±„íŒ…ë°© ë“¤ì–´ê°€ê¸°</button>

        <div class="status" id="statusMessage"></div>
    </div>

    <div class="chat-container" id="chatContainer">
        <div class="chat-header">
            <div class="family-name" id="familyName">ê°€ì¡± ì±„íŒ…ë°©</div>
            <button id="backToLogin" style="background: none; border: none; color: white; cursor: pointer;">â† ë’¤ë¡œê°€ê¸°</button>
        </div>

        <div class="chat-messages" id="chatMessages">
            <div class="loading" id="loading">ë©”ì‹œì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            <div class="no-messages" id="noMessages">ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
        </div>

        <div class="pagination">
            <button class="pagination-button" id="prevPage" disabled>ì´ì „</button>
            <div class="pagination-info" id="pageInfo">í˜ì´ì§€ 1 / 1</div>
            <button class="pagination-button" id="nextPage" disabled>ë‹¤ìŒ</button>
        </div>
    </div>
</div>

<script>
    // ì „ì—­ ë³€ìˆ˜
    let currentPage = 0;
    let hasMoreMessages = false;
    let currentToken = '';
    let currentFamilyId = '';
    let currentUserId = '';
    let totalPages = 1;

    // DOM ìš”ì†Œ
    const loginContainer = document.getElementById('loginContainer');
    const chatContainer = document.getElementById('chatContainer');
    const chatMessages = document.getElementById('chatMessages');
    const loadingElement = document.getElementById('loading');
    const noMessagesElement = document.getElementById('noMessages');
    const statusMessage = document.getElementById('statusMessage');
    const familyNameElement = document.getElementById('familyName');
    const pageInfoElement = document.getElementById('pageInfo');
    const prevPageButton = document.getElementById('prevPage');
    const nextPageButton = document.getElementById('nextPage');

    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    document.getElementById('enterChat').addEventListener('click', enterChatRoom);
    document.getElementById('backToLogin').addEventListener('click', backToLogin);
    prevPageButton.addEventListener('click', goToPrevPage);
    nextPageButton.addEventListener('click', goToNextPage);

    // ì±„íŒ…ë°© ì…ì¥ í•¨ìˆ˜
    function enterChatRoom() {
        const token = document.getElementById('token').value.trim();
        const familyId = document.getElementById('familyId').value.trim();
        const userId = document.getElementById('userId').value.trim();

        if (!token) {
            showStatus('ì¸ì¦ í† í°ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        if (!familyId) {
            showStatus('ê°€ì¡± IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        if (!userId) {
            showStatus('ì‚¬ìš©ì IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        // ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
        currentToken = token;
        currentFamilyId = familyId;
        currentUserId = userId;
        currentPage = 0;

        // ì±„íŒ…ë°© ì œëª© ì—…ë°ì´íŠ¸
        familyNameElement.textContent = `ê°€ì¡± ì±„íŒ…ë°© (ID: ${familyId})`;

        // í™”ë©´ ì „í™˜
        loginContainer.style.display = 'none';
        chatContainer.style.display = 'block';

        // ë©”ì‹œì§€ ë¡œë“œ
        fetchMessages();
    }

    // ë¡œê·¸ì¸ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ê¸°
    function backToLogin() {
        loginContainer.style.display = 'block';
        chatContainer.style.display = 'none';
    }

    // ì´ì „ í˜ì´ì§€ë¡œ ì´ë™
    function goToPrevPage() {
        if (currentPage > 0) {
            currentPage--;
            fetchMessages();
        }
    }

    // ë‹¤ìŒ í˜ì´ì§€ë¡œ ì´ë™
    function goToNextPage() {
        if (hasMoreMessages) {
            currentPage++;
            fetchMessages();
        }
    }

    // ë©”ì‹œì§€ ê°€ì ¸ì˜¤ê¸°
    function fetchMessages() {
        // ë¡œë”© ìƒíƒœ í‘œì‹œ
        loadingElement.style.display = 'block';
        noMessagesElement.style.display = 'none';
        chatMessages.innerHTML = '';
        chatMessages.appendChild(loadingElement);
        chatMessages.appendChild(noMessagesElement);

        const limit = 20; // í•œ í˜ì´ì§€ë‹¹ ë©”ì‹œì§€ ìˆ˜
        const apiUrl = `/api/chat/family/${currentFamilyId}/${currentPage}/messages?limit=${limit}`;

        console.log(`API ìš”ì²­: GET ${apiUrl}`);

        fetch(apiUrl, {
            method: 'GET',
            headers: {
                'Authorization': currentToken.startsWith('Bearer ') ? currentToken : `Bearer ${currentToken}`,
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`ì„œë²„ ì˜¤ë¥˜: ${response.status} ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('ì‘ë‹µ ë°ì´í„°:', data);
            displayMessages(data);

            // í˜ì´ì§€ë„¤ì´ì…˜ ì—…ë°ì´íŠ¸
            hasMoreMessages = data.hasMore;
            updatePagination();
        })
        .catch(error => {
            console.error('API ì˜¤ë¥˜:', error);
            showStatus(`ë©”ì‹œì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
            loadingElement.style.display = 'none';
        });
    }

    // ë©”ì‹œì§€ í‘œì‹œ
    function displayMessages(data) {
        // ë¡œë”© ìˆ¨ê¸°ê¸°
        loadingElement.style.display = 'none';

        // ë©”ì‹œì§€ê°€ ì—†ì„ ë•Œ
        if (!data.messages || data.messages.length === 0) {
            noMessagesElement.style.display = 'block';
            return;
        }

        // ë©”ì‹œì§€ê°€ ìˆì„ ë•Œ
        noMessagesElement.style.display = 'none';

        // ì±„íŒ… ë©”ì‹œì§€ ì»¨í…Œì´ë„ˆ ë¹„ìš°ê¸°
        chatMessages.innerHTML = '';
        chatMessages.appendChild(loadingElement);
        chatMessages.appendChild(noMessagesElement);

        // ë©”ì‹œì§€ ì¶”ê°€
        data.messages.forEach(message => {
            const messageElement = createMessageElement(message);
            chatMessages.appendChild(messageElement);
        });

        // ìŠ¤í¬ë¡¤ì„ ìµœí•˜ë‹¨ìœ¼ë¡œ ì´ë™
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // ë©”ì‹œì§€ ìš”ì†Œ ìƒì„±
    function createMessageElement(message) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message';

        // ë‚´ê°€ ë³´ë‚¸ ë©”ì‹œì§€ì¸ì§€ í™•ì¸
        if (message.senderId === currentUserId) {
            messageDiv.classList.add('sent');
        } else {
            messageDiv.classList.add('received');
        }

        // ë°œì‹ ì ì •ë³´ (ë‚´ê°€ ë³´ë‚¸ ë©”ì‹œì§€ê°€ ì•„ë‹ ë•Œë§Œ í‘œì‹œ)
        if (message.senderId !== currentUserId) {
            const senderDiv = document.createElement('span');
            senderDiv.className = 'message-sender';

            // ë³„ìë¦¬ ì•„ì´ì½˜
            const zodiacIcon = document.createElement('span');
            zodiacIcon.className = 'zodiac-icon';
            zodiacIcon.textContent = getZodiacEmoji(message.senderInfo.userZodiacName);
            zodiacIcon.style.backgroundColor = getZodiacColor(message.senderInfo.userZodiacName);

            senderDiv.appendChild(zodiacIcon);
            senderDiv.appendChild(document.createTextNode(` ${message.senderInfo.nickname}`));
            messageDiv.appendChild(senderDiv);
        }

        // ë©”ì‹œì§€ ë‚´ìš©
        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-content';

        if (message.content.messageType === 'text') {
            contentDiv.textContent = message.content.text;
        } else if (message.content.messageType === 'image' && message.content.imageUrl) {
            const img = document.createElement('img');
            img.src = message.content.imageUrl;
            img.style.maxWidth = '200px';
            img.style.maxHeight = '200px';
            contentDiv.appendChild(img);
        } else {
            contentDiv.textContent = '[ì§€ì›í•˜ì§€ ì•ŠëŠ” ë©”ì‹œì§€ ìœ í˜•]';
        }

        messageDiv.appendChild(contentDiv);

        // ì‹œê°„
        const timeDiv = document.createElement('span');
        timeDiv.className = 'message-time';
        const sentDate = new Date(message.sentAt);
        timeDiv.textContent = formatDateTime(sentDate);
        messageDiv.appendChild(timeDiv);

        return messageDiv;
    }

    // ë³„ìë¦¬ì— ë”°ë¥¸ ìƒ‰ìƒ ë°˜í™˜
    function getZodiacColor(zodiacName) {
        const colors = {
            'Rat': '#FF6B6B',
            'Ox': '#4ECDC4',
            'Tiger': '#FFD166',
            'Rabbit': '#FF90B3',
            'Dragon': '#845EC2',
            'Snake': '#008F7A',
            'Horse': '#FFC75F',
            'Goat': '#F9F871',
            'Monkey': '#FF9671',
            'Rooster': '#D65DB1',
            'Dog': '#4D8076',
            'Pig': '#C34A36'
        };

        return colors[zodiacName] || '#888888';
    }

    // ë³„ìë¦¬ì— ë”°ë¥¸ ì´ëª¨ì§€ ë°˜í™˜
    function getZodiacEmoji(zodiacName) {
        const emojis = {
            'Rat': 'ğŸ€',
            'Ox': 'ğŸ‚',
            'Tiger': 'ğŸ…',
            'Rabbit': 'ğŸ‡',
            'Dragon': 'ğŸ‰',
            'Snake': 'ğŸ',
            'Horse': 'ğŸ',
            'Goat': 'ğŸ',
            'Monkey': 'ğŸ’',
            'Rooster': 'ğŸ“',
            'Dog': 'ğŸ•',
            'Pig': 'ğŸ–'
        };

        return emojis[zodiacName] || '?';
    }

    // ë‚ ì§œ í˜•ì‹ ë³€í™˜
    function formatDateTime(date) {
        const now = new Date();
        const diff = now - date; // í˜„ì¬ì™€ì˜ ì°¨ì´(ë°€ë¦¬ì´ˆ)

        // ì˜¤ëŠ˜ ë‚ ì§œì¸ ê²½ìš° ì‹œê°„ë§Œ í‘œì‹œ
        if (diff < 24 * 60 * 60 * 1000 &&
            date.getDate() === now.getDate() &&
            date.getMonth() === now.getMonth() &&
            date.getFullYear() === now.getFullYear()) {
            return `${padZero(date.getHours())}:${padZero(date.getMinutes())}`;
        } else {
            // ë‹¤ë¥¸ ë‚ ì§œì¸ ê²½ìš° ë‚ ì§œì™€ ì‹œê°„ ëª¨ë‘ í‘œì‹œ
            return `${date.getFullYear()}.${padZero(date.getMonth() + 1)}.${padZero(date.getDate())} ${padZero(date.getHours())}:${padZero(date.getMinutes())}`;
        }
    }

    // í•œ ìë¦¬ ìˆ«ì ì•ì— 0 ë¶™ì´ê¸°
    function padZero(num) {
        return num < 10 ? `0${num}` : num;
    }

    // í˜ì´ì§€ë„¤ì´ì…˜ ì—…ë°ì´íŠ¸
    function updatePagination() {
        // í˜ì´ì§€ ì •ë³´ ê°±ì‹ 
        pageInfoElement.textContent = `í˜ì´ì§€ ${currentPage + 1} ${hasMoreMessages ? '/ ...' : ''}`;

        // ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™”
        prevPageButton.disabled = currentPage <= 0;
        nextPageButton.disabled = !hasMoreMessages;
    }

    // ìƒíƒœ ë©”ì‹œì§€ í‘œì‹œ
    function showStatus(message) {
        statusMessage.textContent = message;
        statusMessage.style.display = 'block';

        // 3ì´ˆ í›„ ìˆ¨ê¸°ê¸°
        setTimeout(() => {
            statusMessage.style.display = 'none';
        }, 3000);
    }
</script>
</body>
</html>