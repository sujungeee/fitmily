<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FitMily 채팅 테스트</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f7fa;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
            border-radius: 4px;
            padding: 20px;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
        }

        .section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #e1e4e8;
            border-radius: 4px;
        }

        h2 {
            margin-top: 0;
            font-size: 18px;
            color: #0066cc;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        input[type="text"], textarea {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
        }

        button:hover {
            background-color: #45a049;
        }

        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .error {
            color: #ff0000;
            font-weight: bold;
        }

        .success {
            color: #4CAF50;
            font-weight: bold;
        }

        .messages {
            height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 15px;
            background-color: #f9f9f9;
        }

        .message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 6px;
            display: inline-block;
            max-width: 80%;
        }

        .message.sent {
            background-color: #dcf8c6;
            margin-left: auto;
            text-align: right;
            float: right;
            clear: both;
        }

        .message.received {
            background-color: #f1f0f0;
            margin-right: auto;
            float: left;
            clear: both;
        }

        .message-info {
            font-size: 12px;
            color: #777;
            margin-top: 4px;
        }

        .console {
            height: 150px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            background-color: #333;
            color: #fff;
            font-family: monospace;
        }

        .log {
            margin: 0;
            padding: 2px 0;
        }

        .log.info {
            color: #7cfc00;
        }

        .log.error {
            color: #ff6347;
        }

        .clearfix::after {
            content: "";
            display: table;
            clear: both;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>FitMily 채팅 테스트</h1>

    <div class="section">
        <h2>1. 연결 설정</h2>

        <div class="form-group">
            <label for="server-url">서버 URL:</label>
            <input type="text" id="server-url" value="http://localhost:8080/api/ws-connect">
        </div>

        <div class="form-group">
            <label for="jwt-token">JWT 토큰:</label>
            <input type="text" id="jwt-token" placeholder="Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...">
        </div>

        <div class="form-group">
            <label for="family-id">가족 ID:</label>
            <input type="text" id="family-id" value="family1">
        </div>

        <button id="connect-btn">연결</button>
        <button id="disconnect-btn" disabled>연결 해제</button>
        <p id="connection-status"></p>
    </div>

    <div class="section">
        <h2>2. 채팅</h2>

        <div class="messages" id="message-container">
            <!-- 메시지가 여기에 표시됩니다 -->
        </div>

        <div class="form-group">
            <label for="message-type">메시지 유형:</label>
            <select id="message-type">
                <option value="text">텍스트</option>
                <option value="image">이미지</option>
            </select>
        </div>

        <div class="form-group">
            <label for="message-content">메시지 내용:</label>
            <textarea id="message-content" rows="3" placeholder="메시지를 입력하세요..." disabled></textarea>
        </div>

        <div class="form-group" id="image-url-group" style="display:none;">
            <label for="image-url">이미지 URL:</label>
            <input type="text" id="image-url" placeholder="https://example.com/image.jpg" disabled>
        </div>

        <button id="send-btn" disabled>전송</button>
    </div>

    <div class="section">
        <h2>3. 읽음 상태 업데이트</h2>

        <div class="form-group">
            <label for="message-id">메시지 ID:</label>
            <input type="text" id="message-id" placeholder="1621234567890_family1" disabled>
        </div>

        <button id="mark-read-btn" disabled>읽음 처리</button>
    </div>

    <div class="section">
        <h2>로그</h2>
        <div class="console" id="console">
            <!-- 로그가 여기에 표시됩니다 -->
        </div>
    </div>
</div>

<script>
    // DOM 요소
    const serverUrlInput = document.getElementById('server-url');
    const jwtTokenInput = document.getElementById('jwt-token');
    const familyIdInput = document.getElementById('family-id');
    const connectBtn = document.getElementById('connect-btn');
    const disconnectBtn = document.getElementById('disconnect-btn');
    const connectionStatus = document.getElementById('connection-status');

    const messageContainer = document.getElementById('message-container');
    const messageTypeSelect = document.getElementById('message-type');
    const messageContentInput = document.getElementById('message-content');
    const imageUrlGroup = document.getElementById('image-url-group');
    const imageUrlInput = document.getElementById('image-url');
    const sendBtn = document.getElementById('send-btn');

    const messageIdInput = document.getElementById('message-id');
    const markReadBtn = document.getElementById('mark-read-btn');

    const consoleElement = document.getElementById('console');

    // 변수
    let stompClient = null;
    let userId = null;

    // 메시지 유형 변경 이벤트
    messageTypeSelect.addEventListener('change', function() {
        if (this.value === 'image') {
            imageUrlGroup.style.display = 'block';
        } else {
            imageUrlGroup.style.display = 'none';
        }
    });

    // 연결 버튼 클릭 이벤트
    connectBtn.addEventListener('click', connect);

    // 연결 해제 버튼 클릭 이벤트
    disconnectBtn.addEventListener('click', disconnect);

    // 메시지 전송 버튼 클릭 이벤트
    sendBtn.addEventListener('click', sendMessage);

    // 읽음 처리 버튼 클릭 이벤트
    markReadBtn.addEventListener('click', markAsRead);

    // 엔터 키 이벤트
    messageContentInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    // 로그 함수
    function log(message, type = 'info') {
        const logElement = document.createElement('p');
        logElement.className = `log ${type}`;
        logElement.textContent = `${new Date().toLocaleTimeString()} - ${message}`;
        consoleElement.appendChild(logElement);
        consoleElement.scrollTop = consoleElement.scrollHeight;
    }

    // 연결 함수
    function connect() {
        const serverUrl = serverUrlInput.value;
        const jwtToken = jwtTokenInput.value;
        const familyId = familyIdInput.value;

        if (!serverUrl || !jwtToken || !familyId) {
            log('서버 URL, JWT 토큰, 가족 ID를 모두 입력해주세요.', 'error');
            return;
        }

        log(`서버에 연결 시도 중... (${serverUrl})`);

        // SockJS 및 STOMP 설정
        const socket = new SockJS(serverUrl);
        stompClient = Stomp.over(socket);

        // 디버그 모드 비활성화 (필요시 활성화)
        stompClient.debug = function(msg) {
            // log(msg);
        };

        // 연결 헤더 설정
        const headers = {
            'Authorization': jwtToken
        };

        // 연결
        stompClient.connect(headers, onConnected, onError);
    }

    // 연결 성공 콜백
    function onConnected(frame) {
        log('서버에 연결되었습니다!');
        connectionStatus.innerHTML = '<span class="success">연결됨</span>';

        // 버튼 상태 변경
        connectBtn.disabled = true;
        disconnectBtn.disabled = false;
        messageContentInput.disabled = false;
        imageUrlInput.disabled = false;
        sendBtn.disabled = false;
        messageIdInput.disabled = false;
        markReadBtn.disabled = false;

        const familyId = familyIdInput.value;

        // 사용자 ID 추출
        try {
            // 단순 테스트용 사용자 ID 추출 (실제로는 서버에서 받아야 함)
            const token = jwtTokenInput.value.split(' ')[1]; // "Bearer " 제거
            const payload = JSON.parse(atob(token.split('.')[1]));
            userId = payload.sub || '1'; // JWT에서 사용자 ID 추출 (subject), 없으면 '1'
            log(`추출된 사용자 ID: ${userId}`);
        } catch (e) {
            log('JWT에서 사용자 ID를 추출할 수 없습니다. 기본값 사용.', 'error');
            userId = '1'; // 기본값
        }

        // 구독
        stompClient.subscribe(`/topic/chat/family/${familyId}`, onMessageReceived);
        log(`채팅방 구독: /topic/chat/family/${familyId}`);
    }

    // 연결 오류 콜백
    function onError(error) {
        log(`연결 오류: ${error}`, 'error');
        connectionStatus.innerHTML = '<span class="error">연결 실패</span>';
    }

    // 연결 해제 함수
    function disconnect() {
        if (stompClient !== null) {
            stompClient.disconnect();
            stompClient = null;

            log('서버 연결이 종료되었습니다.');
            connectionStatus.innerHTML = '<span class="error">연결 끊김</span>';

            // 버튼 상태 변경
            connectBtn.disabled = false;
            disconnectBtn.disabled = true;
            messageContentInput.disabled = true;
            imageUrlInput.disabled = true;
            sendBtn.disabled = true;
            messageIdInput.disabled = true;
            markReadBtn.disabled = true;
        }
    }

    // 메시지 전송 함수
    function sendMessage() {
        if (stompClient && stompClient.connected) {
            const familyId = familyIdInput.value;
            const messageType = messageTypeSelect.value;
            const content = messageContentInput.value.trim();
            const imageUrl = imageUrlInput.value.trim();

            if ((messageType === 'text' && !content) || (messageType === 'image' && !imageUrl)) {
                log('메시지 내용을 입력해주세요.', 'error');
                return;
            }

            const message = {
                messageType: messageType,
                content: content
            };

            if (messageType === 'image') {
                message.imageUrl = imageUrl;
            }

            const destination = `/app/chat.sendMessage/family/${familyId}`;

            log(`메시지 전송: ${JSON.stringify(message)}`);
            stompClient.send(destination, {}, JSON.stringify(message));

            // 입력 필드 초기화
            messageContentInput.value = '';
            imageUrlInput.value = '';
        }
    }

    // 읽음 처리 함수
    function markAsRead() {
        if (stompClient && stompClient.connected) {
            const familyId = familyIdInput.value;
            const messageId = messageIdInput.value.trim();

            if (!messageId) {
                log('메시지 ID를 입력해주세요.', 'error');
                return;
            }

            const readReceipt = {
                messageId: messageId
            };

            const destination = `/app/chat.markAsRead/family/${familyId}`;

            log(`읽음 처리: ${JSON.stringify(readReceipt)}`);
            stompClient.send(destination, {}, JSON.stringify(readReceipt));

            // 입력 필드 초기화
            messageIdInput.value = '';
        }
    }

    // 메시지 수신 콜백
    function onMessageReceived(payload) {
        const messageBody = JSON.parse(payload.body);
        log(`메시지 수신: ${JSON.stringify(messageBody)}`);

        // 메시지 유형에 따른 처리
        if (messageBody.type === 'CHAT_MESSAGE' && messageBody.data) {
            addMessageToUI(messageBody.data);
        } else if (messageBody.type === 'READ_RECEIPT') {
            updateReadStatus(messageBody.data);
        }
    }

    // UI에 메시지 추가
    function addMessageToUI(message) {
        const messageElement = document.createElement('div');
        messageElement.className = `message ${message.senderId === userId ? 'sent' : 'received'}`;

        let content = '';

        // 발신자 정보
        const senderInfo = message.senderInfo ?
            message.senderInfo.nickname :
            `User ${message.senderId}`;

        content += `<strong>${senderInfo}</strong><br>`;

        // 메시지 내용
        if (message.content.messageType === 'image') {
            content += `<img src="${message.content.imageUrl}" style="max-width:200px;"><br>`;
            if (message.content.text) {
                content += `${message.content.text}<br>`;
            }
        } else {
            content += `${message.content.text}<br>`;
        }

        // 메시지 정보 (시간, ID)
        const timestamp = new Date(message.sentAt).toLocaleTimeString();
        content += `<div class="message-info">${timestamp} | ID: ${message.messageId} | 읽지 않음: ${message.unreadCount}</div>`;

        messageElement.innerHTML = content;
        messageContainer.appendChild(messageElement);
        messageContainer.scrollTop = messageContainer.scrollHeight;

        // 전송된 메시지 ID를 읽음 처리 입력 필드에 자동 입력
        if (message.senderId !== userId) {
            messageIdInput.value = message.messageId;
        }
    }

    // 읽음 상태 업데이트
    function updateReadStatus(data) {
        log(`읽음 상태 업데이트: 사용자 ${data.userId}가 메시지 ${data.messageId}까지 읽음`);

        // UI 업데이트 (필요시 구현)
    }
</script>
</body>
</html>