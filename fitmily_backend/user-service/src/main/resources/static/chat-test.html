<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fitmily 채팅방 테스트</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Apple SD Gothic Neo', 'Noto Sans KR', sans-serif;
        }

        body {
            background-color: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .login-container {
            padding: 20px;
            border-bottom: 1px solid #eee;
        }

        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 20px;
            font-size: 24px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }

        .button {
            display: inline-block;
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            transition: background-color 0.2s;
            width: 100%;
        }

        .button:hover {
            background-color: #45a049;
        }

        .chat-container {
            display: none;
            height: 500px;
            position: relative;
        }

        .chat-header {
            padding: 15px;
            background-color: #4CAF50;
            color: white;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .family-name {
            font-size: 18px;
        }

        .chat-messages {
            padding: 15px;
            height: 400px;
            overflow-y: auto;
            background-color: #f9f9f9;
        }

        .message {
            margin-bottom: 15px;
            max-width: 80%;
            clear: both;
        }

        .message.received {
            float: left;
        }

        .message.sent {
            float: right;
        }

        .message-content {
            background-color: #e5e5ea;
            padding: 10px;
            border-radius: 15px;
            position: relative;
            word-break: break-word;
        }

        .message.sent .message-content {
            background-color: #dcf8c6;
        }

        .message-sender {
            font-size: 12px;
            color: #777;
            margin-bottom: 3px;
            display: block;
        }

        .message-time {
            font-size: 11px;
            color: #999;
            text-align: right;
            margin-top: 2px;
            display: block;
        }

        .chat-footer {
            padding: 15px;
            border-top: 1px solid #eee;
            display: flex;
            align-items: center;
        }

        .pagination {
            display: flex;
            justify-content: center;
            padding: 10px;
            background-color: #fff;
            border-top: 1px solid #eee;
        }

        .pagination-button {
            background-color: #eee;
            border: none;
            padding: 8px 15px;
            margin: 0 5px;
            border-radius: 4px;
            cursor: pointer;
        }

        .pagination-button:disabled {
            background-color: #f5f5f5;
            color: #aaa;
            cursor: not-allowed;
        }

        .pagination-info {
            display: flex;
            align-items: center;
            color: #777;
            font-size: 14px;
        }

        .status {
            padding: 10px;
            background-color: #f8d7da;
            color: #721c24;
            border-radius: 5px;
            margin-top: 10px;
            display: none;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .zodiac-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
            vertical-align: middle;
            text-align: center;
            line-height: 20px;
            font-size: 12px;
            color: white;
            font-weight: bold;
        }

        /* 채팅방에 새로운 메시지가 없을 때 */
        .no-messages {
            text-align: center;
            color: #999;
            padding: 20px;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="login-container" id="loginContainer">
        <h1>Fitmily 채팅방 테스트</h1>

        <div class="form-group">
            <label for="token">인증 토큰</label>
            <input type="text" id="token" placeholder="JWT 토큰을 입력하세요">
        </div>

        <div class="form-group">
            <label for="familyId">가족 ID</label>
            <input type="text" id="familyId" placeholder="가족 ID를 입력하세요">
        </div>

        <div class="form-group">
            <label for="userId">사용자 ID (UI 표시용)</label>
            <input type="text" id="userId" placeholder="사용자 ID를 입력하세요">
        </div>

        <button class="button" id="enterChat">채팅방 들어가기</button>

        <div class="status" id="statusMessage"></div>
    </div>

    <div class="chat-container" id="chatContainer">
        <div class="chat-header">
            <div class="family-name" id="familyName">가족 채팅방</div>
            <button id="backToLogin" style="background: none; border: none; color: white; cursor: pointer;">← 뒤로가기</button>
        </div>

        <div class="chat-messages" id="chatMessages">
            <div class="loading" id="loading">메시지를 불러오는 중...</div>
            <div class="no-messages" id="noMessages">메시지가 없습니다.</div>
        </div>

        <div class="pagination">
            <button class="pagination-button" id="prevPage" disabled>이전</button>
            <div class="pagination-info" id="pageInfo">페이지 1 / 1</div>
            <button class="pagination-button" id="nextPage" disabled>다음</button>
        </div>
    </div>
</div>

<script>
    // 전역 변수
    let currentPage = 0;
    let hasMoreMessages = false;
    let currentToken = '';
    let currentFamilyId = '';
    let currentUserId = '';
    let totalPages = 1;

    // DOM 요소
    const loginContainer = document.getElementById('loginContainer');
    const chatContainer = document.getElementById('chatContainer');
    const chatMessages = document.getElementById('chatMessages');
    const loadingElement = document.getElementById('loading');
    const noMessagesElement = document.getElementById('noMessages');
    const statusMessage = document.getElementById('statusMessage');
    const familyNameElement = document.getElementById('familyName');
    const pageInfoElement = document.getElementById('pageInfo');
    const prevPageButton = document.getElementById('prevPage');
    const nextPageButton = document.getElementById('nextPage');

    // 이벤트 리스너
    document.getElementById('enterChat').addEventListener('click', enterChatRoom);
    document.getElementById('backToLogin').addEventListener('click', backToLogin);
    prevPageButton.addEventListener('click', goToPrevPage);
    nextPageButton.addEventListener('click', goToNextPage);

    // 채팅방 입장 함수
    function enterChatRoom() {
        const token = document.getElementById('token').value.trim();
        const familyId = document.getElementById('familyId').value.trim();
        const userId = document.getElementById('userId').value.trim();

        if (!token) {
            showStatus('인증 토큰을 입력해주세요.');
            return;
        }

        if (!familyId) {
            showStatus('가족 ID를 입력해주세요.');
            return;
        }

        if (!userId) {
            showStatus('사용자 ID를 입력해주세요.');
            return;
        }

        // 전역 변수에 저장
        currentToken = token;
        currentFamilyId = familyId;
        currentUserId = userId;
        currentPage = 0;

        // 채팅방 제목 업데이트
        familyNameElement.textContent = `가족 채팅방 (ID: ${familyId})`;

        // 화면 전환
        loginContainer.style.display = 'none';
        chatContainer.style.display = 'block';

        // 메시지 로드
        fetchMessages();
    }

    // 로그인 화면으로 돌아가기
    function backToLogin() {
        loginContainer.style.display = 'block';
        chatContainer.style.display = 'none';
    }

    // 이전 페이지로 이동
    function goToPrevPage() {
        if (currentPage > 0) {
            currentPage--;
            fetchMessages();
        }
    }

    // 다음 페이지로 이동
    function goToNextPage() {
        if (hasMoreMessages) {
            currentPage++;
            fetchMessages();
        }
    }

    // 메시지 가져오기
    function fetchMessages() {
        // 로딩 상태 표시
        loadingElement.style.display = 'block';
        noMessagesElement.style.display = 'none';
        chatMessages.innerHTML = '';
        chatMessages.appendChild(loadingElement);
        chatMessages.appendChild(noMessagesElement);

        const limit = 20; // 한 페이지당 메시지 수
        const apiUrl = `/api/chat/family/${currentFamilyId}/${currentPage}/messages?limit=${limit}`;

        console.log(`API 요청: GET ${apiUrl}`);

        fetch(apiUrl, {
            method: 'GET',
            headers: {
                'Authorization': currentToken.startsWith('Bearer ') ? currentToken : `Bearer ${currentToken}`,
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`서버 오류: ${response.status} ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('응답 데이터:', data);
            displayMessages(data);

            // 페이지네이션 업데이트
            hasMoreMessages = data.hasMore;
            updatePagination();
        })
        .catch(error => {
            console.error('API 오류:', error);
            showStatus(`메시지를 불러오는 중 오류가 발생했습니다: ${error.message}`);
            loadingElement.style.display = 'none';
        });
    }

    // 메시지 표시
    function displayMessages(data) {
        // 로딩 숨기기
        loadingElement.style.display = 'none';

        // 메시지가 없을 때
        if (!data.messages || data.messages.length === 0) {
            noMessagesElement.style.display = 'block';
            return;
        }

        // 메시지가 있을 때
        noMessagesElement.style.display = 'none';

        // 채팅 메시지 컨테이너 비우기
        chatMessages.innerHTML = '';
        chatMessages.appendChild(loadingElement);
        chatMessages.appendChild(noMessagesElement);

        // 메시지 추가
        data.messages.forEach(message => {
            const messageElement = createMessageElement(message);
            chatMessages.appendChild(messageElement);
        });

        // 스크롤을 최하단으로 이동
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // 메시지 요소 생성
    function createMessageElement(message) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message';

        // 내가 보낸 메시지인지 확인
        if (message.senderId === currentUserId) {
            messageDiv.classList.add('sent');
        } else {
            messageDiv.classList.add('received');
        }

        // 발신자 정보 (내가 보낸 메시지가 아닐 때만 표시)
        if (message.senderId !== currentUserId) {
            const senderDiv = document.createElement('span');
            senderDiv.className = 'message-sender';

            // 별자리 아이콘
            const zodiacIcon = document.createElement('span');
            zodiacIcon.className = 'zodiac-icon';
            zodiacIcon.textContent = getZodiacEmoji(message.senderInfo.userZodiacName);
            zodiacIcon.style.backgroundColor = getZodiacColor(message.senderInfo.userZodiacName);

            senderDiv.appendChild(zodiacIcon);
            senderDiv.appendChild(document.createTextNode(` ${message.senderInfo.nickname}`));
            messageDiv.appendChild(senderDiv);
        }

        // 메시지 내용
        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-content';

        if (message.content.messageType === 'text') {
            contentDiv.textContent = message.content.text;
        } else if (message.content.messageType === 'image' && message.content.imageUrl) {
            const img = document.createElement('img');
            img.src = message.content.imageUrl;
            img.style.maxWidth = '200px';
            img.style.maxHeight = '200px';
            contentDiv.appendChild(img);
        } else {
            contentDiv.textContent = '[지원하지 않는 메시지 유형]';
        }

        messageDiv.appendChild(contentDiv);

        // 시간
        const timeDiv = document.createElement('span');
        timeDiv.className = 'message-time';
        const sentDate = new Date(message.sentAt);
        timeDiv.textContent = formatDateTime(sentDate);
        messageDiv.appendChild(timeDiv);

        return messageDiv;
    }

    // 별자리에 따른 색상 반환
    function getZodiacColor(zodiacName) {
        const colors = {
            'Rat': '#FF6B6B',
            'Ox': '#4ECDC4',
            'Tiger': '#FFD166',
            'Rabbit': '#FF90B3',
            'Dragon': '#845EC2',
            'Snake': '#008F7A',
            'Horse': '#FFC75F',
            'Goat': '#F9F871',
            'Monkey': '#FF9671',
            'Rooster': '#D65DB1',
            'Dog': '#4D8076',
            'Pig': '#C34A36'
        };

        return colors[zodiacName] || '#888888';
    }

    // 별자리에 따른 이모지 반환
    function getZodiacEmoji(zodiacName) {
        const emojis = {
            'Rat': '🐀',
            'Ox': '🐂',
            'Tiger': '🐅',
            'Rabbit': '🐇',
            'Dragon': '🐉',
            'Snake': '🐍',
            'Horse': '🐎',
            'Goat': '🐐',
            'Monkey': '🐒',
            'Rooster': '🐓',
            'Dog': '🐕',
            'Pig': '🐖'
        };

        return emojis[zodiacName] || '?';
    }

    // 날짜 형식 변환
    function formatDateTime(date) {
        const now = new Date();
        const diff = now - date; // 현재와의 차이(밀리초)

        // 오늘 날짜인 경우 시간만 표시
        if (diff < 24 * 60 * 60 * 1000 &&
            date.getDate() === now.getDate() &&
            date.getMonth() === now.getMonth() &&
            date.getFullYear() === now.getFullYear()) {
            return `${padZero(date.getHours())}:${padZero(date.getMinutes())}`;
        } else {
            // 다른 날짜인 경우 날짜와 시간 모두 표시
            return `${date.getFullYear()}.${padZero(date.getMonth() + 1)}.${padZero(date.getDate())} ${padZero(date.getHours())}:${padZero(date.getMinutes())}`;
        }
    }

    // 한 자리 숫자 앞에 0 붙이기
    function padZero(num) {
        return num < 10 ? `0${num}` : num;
    }

    // 페이지네이션 업데이트
    function updatePagination() {
        // 페이지 정보 갱신
        pageInfoElement.textContent = `페이지 ${currentPage + 1} ${hasMoreMessages ? '/ ...' : ''}`;

        // 버튼 활성화/비활성화
        prevPageButton.disabled = currentPage <= 0;
        nextPageButton.disabled = !hasMoreMessages;
    }

    // 상태 메시지 표시
    function showStatus(message) {
        statusMessage.textContent = message;
        statusMessage.style.display = 'block';

        // 3초 후 숨기기
        setTimeout(() => {
            statusMessage.style.display = 'none';
        }, 3000);
    }
</script>
</body>
</html>