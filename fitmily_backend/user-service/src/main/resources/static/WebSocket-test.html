<!DOCTYPE html>
<html>
<head>
    <title>WebSocket 테스트</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
</head>
<body>
<h1>WebSocket 테스트</h1>
<div>
    <label for="token">JWT 토큰:</label>
    <input type="text" id="token" style="width: 500px;">
</div>
<div>
    <button onclick="connect()">연결</button>
    <button onclick="disconnect()">연결 해제</button>
</div>
<div>
    <h2>로그:</h2>
    <pre id="log" style="height: 300px; overflow-y: scroll; border: 1px solid #ccc; padding: 10px;"></pre>
</div>

<script>
    let stompClient = null;
    const logElement = document.getElementById('log');

    function log(message) {
        const timestamp = new Date().toLocaleTimeString();
        logElement.textContent += `${timestamp}: ${message}\n`;
        logElement.scrollTop = logElement.scrollHeight;
    }

    function connect() {
        log("연결 시도 중...");
        const token = document.getElementById('token').value;

        // SockJS 옵션 설정
        const sockjsOptions = {
            transports: ["websocket", "xhr-streaming", "xhr-polling"],
            withCredentials: false  // credentials 끄기
        };

        try {
            // SockJS 객체 생성 - 옵션 적용
            const socket = new SockJS('/api/ws-connect', null, sockjsOptions);
            stompClient = Stomp.over(socket);

            // 디버깅 활성화
            stompClient.debug = function(str) {
                log(`STOMP: ${str}`);
            };

            const headers = {
                'Authorization': `Bearer ${token}`
            };

            stompClient.connect(headers,
                frame => {
                    log(`연결 성공: ${frame}`);
                    // 테스트 구독
                    stompClient.subscribe('/topic/chat.test', message => {
                        log(`메시지 수신: ${message.body}`);
                    });
                },
                error => {
                    log(`연결 실패: ${error}`);
                    stompClient = null;
                }
            );
        } catch (e) {
            log(`연결 오류: ${e.message}`);
        }
    }

    function disconnect() {
        if (stompClient) {
            stompClient.disconnect();
            log("연결 종료");
            stompClient = null;
        }
    }
</script>
</body>
</html>