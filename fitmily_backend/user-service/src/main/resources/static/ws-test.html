<!DOCTYPE html>
<html>
<head>
    <title>WebSocket 채팅 테스트</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        #chat-container {
            width: 600px;
            margin: 0 auto;
        }
        #message-container {
            height: 400px;
            border: 1px solid #ccc;
            overflow-y: auto;
            margin-bottom: 10px;
            padding: 10px;
        }
        #message-form {
            display: flex;
        }
        #message-input {
            flex-grow: 1;
            margin-right: 10px;
        }
        .timestamp {
            color: #999;
            font-size: 0.8em;
            margin-left: 10px;
        }
    </style>
</head>
<body>
<div id="chat-container">
    <h2>FitMily 채팅 테스트</h2>
    <div>
        <label for="family-id">가족 ID:</label>
        <input type="text" id="family-id" value="1" />
        <label for="user-id">사용자 ID:</label>
        <input type="text" id="user-id" value="2" />
        <button id="connect-btn">연결</button>
        <button id="disconnect-btn" disabled>연결 해제</button>
    </div>
    <div id="message-container"></div>
    <form id="message-form">
        <input type="text" id="message-input" placeholder="메시지 입력..." />
        <button type="submit">전송</button>
    </form>
</div>

<script>
    let stompClient = null;
    const messageContainer = document.getElementById('message-container');
    const connectBtn = document.getElementById('connect-btn');
    const disconnectBtn = document.getElementById('disconnect-btn');
    const messageForm = document.getElementById('message-form');
    const messageInput = document.getElementById('message-input');
    const familyIdInput = document.getElementById('family-id');
    const userIdInput = document.getElementById('user-id');

    connectBtn.addEventListener('click', connect);
    disconnectBtn.addEventListener('click', disconnect);
    messageForm.addEventListener('submit', sendMessage);

    function connect() {
        const familyId = familyIdInput.value;
        const userId = userIdInput.value;

        if (!familyId || !userId) {
            alert('가족 ID와 사용자 ID를 입력하세요.');
            return;
        }

        // SockJS와 STOMP 클라이언트를 생성하고 연결
        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);

        // 헤더에 인증 정보를 추가 (X-Auth-User-Id 헤더 사용)
        const headers = {
            'X-Auth-User-Id': userId
        };

        stompClient.connect(headers, function(frame) {
            console.log('연결됨: ' + frame);
            addMessage('시스템', '연결되었습니다.');

            // 채팅방 구독
            stompClient.subscribe('/topic/chat/family/' + familyId, function(message) {
                const msgData = JSON.parse(message.body);
                console.log('수신된 메시지:', msgData);

                if (msgData.type === 'CHAT_MESSAGE') {
                    const chatMsg = msgData.data;
                    const senderNickname = chatMsg.senderInfo ? chatMsg.senderInfo.nickname : '알 수 없음';
                    const msgText = chatMsg.content ? chatMsg.content.text : '(내용 없음)';
                    const sentTime = new Date(chatMsg.sentAt).toLocaleTimeString();

                    addMessage(senderNickname, msgText, sentTime);
                } else if (msgData.type === 'READ_RECEIPT') {
                    console.log('읽음 확인:', msgData.data);
                    addMessage('시스템', `${msgData.data.userId}님이 메시지를 읽었습니다.`);
                }
            });

            connectBtn.disabled = true;
            disconnectBtn.disabled = false;
        }, function(error) {
            console.error('연결 오류:', error);
            addMessage('시스템', '연결 오류: ' + error);
        });
    }

    function disconnect() {
        if (stompClient !== null) {
            stompClient.disconnect();
            stompClient = null;
            addMessage('시스템', '연결이 종료되었습니다.');
            connectBtn.disabled = false;
            disconnectBtn.disabled = true;
        }
    }

    function sendMessage(event) {
        event.preventDefault();

        if (!stompClient) {
            alert('먼저 연결하세요.');
            return;
        }

        const familyId = familyIdInput.value;
        const messageText = messageInput.value;

        if (!messageText) return;

        const message = {
            messageType: 'text',
            content: messageText,
            imageUrl: null
        };

        stompClient.send(`/app/chat.sendMessage/family/${familyId}`, {}, JSON.stringify(message));
        messageInput.value = '';
    }

    function addMessage(sender, content, timestamp) {
        const msgElement = document.createElement('div');
        const msgText = document.createElement('span');
        msgText.textContent = `${sender}: ${content}`;

        msgElement.appendChild(msgText);

        if (timestamp) {
            const timeSpan = document.createElement('span');
            timeSpan.textContent = timestamp;
            timeSpan.className = 'timestamp';
            msgElement.appendChild(timeSpan);
        }

        messageContainer.appendChild(msgElement);
        messageContainer.scrollTop = messageContainer.scrollHeight;
    }
</script>
</body>
</html>